# è±†ç“£ç”µå½±çˆ¬è™«ç³»ç»Ÿå®Œæ•´æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„è±†ç“£ç”µå½±ä¿¡æ¯çˆ¬è™«ç³»ç»Ÿï¼Œé…å¤‡å¼ºå¤§çš„åçˆ¬è™«æœºåˆ¶å’ŒGUIç•Œé¢ï¼Œå¯ä»¥æ‰¹é‡çˆ¬å–è±†ç“£ç”µå½±çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”µå½±åç§°ã€å¯¼æ¼”ã€æ¼”å‘˜ã€è¯„åˆ†ã€å‰§æƒ…ç®€ä»‹ç­‰æ•°æ®ã€‚

---

## ğŸ—ï¸ 1. ä»£ç åº•å±‚é€»è¾‘ä¸æ¶æ„

### 1.1 ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GUIç•Œé¢å±‚     â”‚ -> â”‚   çˆ¬è™«å¼•æ“å±‚    â”‚ -> â”‚   æ•°æ®å¤„ç†å±‚    â”‚
â”‚  (Tkinter)      â”‚    â”‚ (DoubanCrawler) â”‚    â”‚ (Excel/æ•°æ®åº“)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         v                       v                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·äº¤äº’      â”‚    â”‚   è¯·æ±‚ç®¡ç†      â”‚    â”‚   ç»“æœè¾“å‡º      â”‚
â”‚   æ–‡ä»¶é€‰æ‹©      â”‚    â”‚   ä¼šè¯ç®¡ç†      â”‚    â”‚   çŠ¶æ€æ›´æ–°      â”‚
â”‚   å‚æ•°é…ç½®      â”‚    â”‚   åçˆ¬å¤„ç†      â”‚    â”‚   æ—¥å¿—è®°å½•      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç±»ç»“æ„

#### DoubanCrawler ç±»ï¼ˆçˆ¬è™«æ ¸å¿ƒï¼‰
- **åŠŸèƒ½**: è´Ÿè´£æ‰€æœ‰çˆ¬è™«é€»è¾‘ï¼ŒåŒ…æ‹¬ç½‘ç»œè¯·æ±‚ã€æ•°æ®è§£æã€åçˆ¬å¤„ç†
- **å…³é”®æ–¹æ³•**:
  - `crawl_movie_info()`: çˆ¬å–å•ä¸ªç”µå½±ä¿¡æ¯
  - `request_with_intelligent_retry()`: æ™ºèƒ½é‡è¯•æœºåˆ¶
  - `detect_anti_crawler()`: åçˆ¬æ£€æµ‹
  - `generate_dynamic_cookies()`: **ğŸ”¥æ ¸å¿ƒæ›´æ–°** åŠ¨æ€Cookieç”Ÿæˆ

#### DoubanCrawlerApp ç±»ï¼ˆGUIç•Œé¢ï¼‰
- **åŠŸèƒ½**: æä¾›ç”¨æˆ·å‹å¥½çš„å›¾å½¢ç•Œé¢
- **å…³é”®æ–¹æ³•**:
  - `setup_ui()`: ç•Œé¢å¸ƒå±€
  - `crawl_worker()`: å¤šçº¿ç¨‹çˆ¬å–å·¥ä½œè€…
  - `update_ui()`: å®æ—¶çŠ¶æ€æ›´æ–°

### 1.3 æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·é€‰æ‹©Excelæ–‡ä»¶ â†’ è¯»å–ç”µå½±åç§°åˆ—è¡¨ â†’ éå†æ¯ä¸ªç”µå½±åç§° â†’ æœç´¢è±†ç“£
     â†“
ç”Ÿæˆæœç´¢URL â†’ å‘é€HTTPè¯·æ±‚ â†’ è§£ææœç´¢ç»“æœ â†’ è·å–ç”µå½±è¯¦æƒ…é¡µURL
     â†“
è®¿é—®è¯¦æƒ…é¡µ â†’ è§£æç”µå½±ä¿¡æ¯ â†’ æ•°æ®éªŒè¯ä¸æ¸…æ´— â†’ å†™å…¥Excelæ–‡ä»¶
     â†“
æ›´æ–°GUIçŠ¶æ€ â†’ è®°å½•æ—¥å¿— â†’ ç»§ç»­ä¸‹ä¸€ä¸ªç”µå½±
```

---

## ğŸš€ 2. å…¨éƒ¨åŠŸèƒ½ç‰¹æ€§

### 2.1 æ ¸å¿ƒçˆ¬å–åŠŸèƒ½

| æ•°æ®å­—æ®µ | åŠŸèƒ½æè¿° | è§£ææ–¹æ³• |
|---------|---------|---------|
| ç”µå½±åç§° | è±†ç“£å®˜æ–¹æ ‡é¢˜ | CSSé€‰æ‹©å™¨ `span[property="v:itemreviewed"]` |
| å¯¼æ¼” | å¯¼æ¼”å§“å | CSSé€‰æ‹©å™¨ `span.attrs` |
| ç¼–å‰§ | ç¼–å‰§ä¿¡æ¯ | XPathè§£æé‚»æ¥èŠ‚ç‚¹ |
| ä¸»æ¼” | ä¸»è¦æ¼”å‘˜åˆ—è¡¨ | CSSé€‰æ‹©å™¨è¿‡æ»¤å¯¼æ¼”é‡å¤ |
| ç±»å‹ | ç”µå½±åˆ†ç±»æ ‡ç­¾ | CSSé€‰æ‹©å™¨ `span[property="v:genre"]` |
| åˆ¶ç‰‡å›½å®¶ | åˆ¶ä½œåœ°åŒº | æ–‡æœ¬èŠ‚ç‚¹è§£æ |
| è¯­è¨€ | ç”µå½±è¯­è¨€ | æ–‡æœ¬èŠ‚ç‚¹è§£æ |
| ä¸Šæ˜ æ—¥æœŸ | é¦–æ˜ æ—¶é—´ | CSSé€‰æ‹©å™¨ `span[property="v:initialReleaseDate"]` |
| ç‰‡é•¿ | ç”µå½±æ—¶é•¿ | CSSé€‰æ‹©å™¨ `span[property="v:runtime"]` |
| åˆå | åˆ«åä¿¡æ¯ | å¤æ‚æ–‡æœ¬è§£æ |
| IMDbé“¾æ¥ | å›½é™…ç”µå½±æ•°æ®åº“é“¾æ¥ | é“¾æ¥æå– |
| å‰§æƒ…ç®€ä»‹ | ç”µå½±ä»‹ç» | CSSé€‰æ‹©å™¨ `span[property="v:summary"]` |
| è±†ç“£è¯„åˆ† | è¯„åˆ†æ•°å€¼ | CSSé€‰æ‹©å™¨ `.rating_num` |
| è¯„ä»·äººæ•° | è¯„åˆ†äººæ•° | CSSé€‰æ‹©å™¨ `span[property="v:votes"]` |
| **ğŸ†•æµ·æŠ¥URL** | **ç”µå½±æµ·æŠ¥å›¾ç‰‡é“¾æ¥** | **CSSé€‰æ‹©å™¨ `#mainpic img` + å¤§å›¾è½¬æ¢** |
| **ğŸ†•è±†ç“£ID** | **è±†ç“£å”¯ä¸€æ ‡è¯†ç¬¦** | **URLæ­£åˆ™æå– `/subject/(\d+)/`** |

### 2.2 æ™ºèƒ½åŠŸèƒ½

#### 2.2.1 **ğŸ”¥é‡ç‚¹æ›´æ–°** åŠ¨æ€åçˆ¬ç³»ç»Ÿ
- âœ… **åŠ¨æ€Cookieç”Ÿæˆ**: æ¯æ¬¡ä¼šè¯è‡ªåŠ¨ç”Ÿæˆ11ä½éšæœºbid
- âœ… **æ™ºèƒ½å»¶è¿Ÿç­–ç•¥**: åŒé‡å»¶è¿Ÿæœºåˆ¶ï¼ˆéšæœº0-1ç§’+åŸºç¡€8-12ç§’ï¼‰
- âœ… **User-Agentè½®æ¢**: 12ä¸ªçœŸå®æµè§ˆå™¨UAéšæœºé€‰æ‹©
- âœ… **è¯·æ±‚å¤´å®Œå–„**: Originã€Refererç­‰å…³é”®å¤´éƒ¨
- âœ… **ä¼šè¯ç®¡ç†**: 20åˆ†é’Ÿæˆ–50è¯·æ±‚è‡ªåŠ¨é‡å»ºä¼šè¯

#### 2.2.2 é”™è¯¯å¤„ç†ä¸é‡è¯•
- ğŸ”§ æœ€å¤š5æ¬¡æ™ºèƒ½é‡è¯•
- ğŸ”§ æ¸è¿›å¼é‡è¯•é—´éš”
- ğŸ”§ ä¼šè¯è‡ªåŠ¨é‡å»º
- ğŸ”§ åçˆ¬æ£€æµ‹ä¸å¤„ç†

#### 2.2.3 æ•°æ®éªŒè¯
- âœ… ç”µå½±åç§°åŒ¹é…éªŒè¯
- âœ… é¡µé¢å†…å®¹å®Œæ•´æ€§æ£€æŸ¥
- âœ… çŠ¶æ€ç å¼‚å¸¸æ£€æµ‹
- âœ… åçˆ¬å…³é”®è¯æ£€æµ‹

### 2.3 ç”¨æˆ·ç•Œé¢åŠŸèƒ½

#### 2.3.1 æ–‡ä»¶æ“ä½œ
- ğŸ“ Excelæ–‡ä»¶é€‰æ‹©ä¸åŠ è½½
- ğŸ“Š å¤šå·¥ä½œè¡¨æ”¯æŒ
- ğŸ’¾ å®æ—¶æ•°æ®ä¿å­˜
- ğŸ“‹ æ•°æ®é¢„è§ˆ

#### 2.3.2 çˆ¬å–æ§åˆ¶
- â–¶ï¸ å¼€å§‹/æš‚åœ/åœæ­¢æ§åˆ¶
- âš™ï¸ å‚æ•°é…ç½®ï¼ˆå»¶è¿Ÿã€é‡è¯•ç­‰ï¼‰
- ğŸ“ˆ å®æ—¶è¿›åº¦æ˜¾ç¤º
- ğŸ“Š çˆ¬å–ç»Ÿè®¡

#### 2.3.3 çŠ¶æ€ç›‘æ§
- ğŸ¯ æˆåŠŸç‡å®æ—¶æ˜¾ç¤º
- â±ï¸ å»¶è¿Ÿç­–ç•¥çŠ¶æ€
- ğŸ”„ è¿ç»­å¤±è´¥æ¬¡æ•°
- ğŸ“ è¯¦ç»†æ—¥å¿—è®°å½•

---

## ğŸ“– 3. ä½¿ç”¨æ–¹å¼

### 3.1 ç¯å¢ƒå‡†å¤‡

#### 3.1.1 Pythonç‰ˆæœ¬è¦æ±‚
```bash
Python 3.7+ (æ¨è3.8+)
```

#### 3.1.2 ä¾èµ–åŒ…å®‰è£…
```bash
pip install requests beautifulsoup4 openpyxl
```

æˆ–è€…è¿è¡Œè‡ªåŠ¨å®‰è£…ï¼š
```bash
python ç¯å¢ƒå®‰è£…å·¥å…·.py
```

### 3.2 Excelæ–‡ä»¶å‡†å¤‡

#### 3.2.1 æ–‡ä»¶æ ¼å¼è¦æ±‚
- æ”¯æŒ `.xlsx` å’Œ `.xls` æ ¼å¼
- å¿…é¡»åŒ…å«ç”µå½±åç§°åˆ—
- æ”¯æŒå¤šå·¥ä½œè¡¨

#### 3.2.2 æ•°æ®æ ¼å¼ç¤ºä¾‹
| ç”µå½±åç§° | å¤‡æ³¨ |
|---------|------|
| è‚–ç”³å…‹çš„æ•‘èµ | ç»å…¸ç”µå½± |
| é˜¿ç”˜æ­£ä¼  | åŠ±å¿—ç‰‡ |
| æ³°å¦å°¼å…‹å· | çˆ±æƒ…ç‰‡ |

### 3.3 è¿è¡Œæ­¥éª¤

#### 3.3.1 å¯åŠ¨ç¨‹åº
```bash
python main.py
```

#### 3.3.2 æ“ä½œæµç¨‹
1. **é€‰æ‹©æ–‡ä»¶**: ç‚¹å‡»"é€‰æ‹©Excelæ–‡ä»¶"æŒ‰é’®
2. **é€‰æ‹©å·¥ä½œè¡¨**: ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©åŒ…å«ç”µå½±åç§°çš„å·¥ä½œè¡¨
3. **é…ç½®å‚æ•°** (å¯é€‰): 
   - è°ƒæ•´å»¶è¿Ÿæ—¶é—´
   - è®¾ç½®é‡è¯•æ¬¡æ•°
   - é…ç½®å¹¶å‘æ•°
4. **å¼€å§‹çˆ¬å–**: ç‚¹å‡»"å¼€å§‹çˆ¬å–"æŒ‰é’®
5. **ç›‘æ§è¿›åº¦**: è§‚å¯Ÿè¿›åº¦æ¡å’Œç»Ÿè®¡ä¿¡æ¯
6. **æŸ¥çœ‹ç»“æœ**: çˆ¬å–å®ŒæˆåæŸ¥çœ‹Excelæ–‡ä»¶ä¸­çš„æ–°å¢æ•°æ®

### 3.4 é«˜çº§ç”¨æ³•

#### 3.4.1 æ‰¹å¤„ç†æ¨¡å¼
```bash
# ä¸€é”®å¯åŠ¨è„šæœ¬
python ä¸€é”®å¯åŠ¨.bat
```

#### 3.4.2 å‚æ•°è°ƒä¼˜
- **ç½‘ç»œè¾ƒæ…¢**: å¢åŠ å»¶è¿Ÿæ—¶é—´åˆ°15-20ç§’
- **æˆåŠŸç‡è¾ƒä½**: å‡å°‘å¹¶å‘æ•°ï¼Œå¢åŠ é‡è¯•æ¬¡æ•°
- **æœåŠ¡å™¨ç¹å¿™**: å¯ç”¨ä»£ç†æ¨¡å¼

---

## ğŸ”„ 4. å¯¹æ¯”åŸç‰ˆæœ¬æ›´æ–°å†…å®¹

### 4.1 **ğŸ”¥æ ¸å¿ƒåçˆ¬æŠ€æœ¯å‡çº§**

#### 4.1.1 åŠ¨æ€Cookieç³»ç»Ÿ (å…¨æ–°åŠŸèƒ½)
**åŸç‰ˆæœ¬é—®é¢˜**:
```python
# å›ºå®šCookieï¼Œå®¹æ˜“è¢«è¯†åˆ«
'Cookie': 'bid=fresh_new_bid'
```

**æ–°ç‰ˆæœ¬è§£å†³æ–¹æ¡ˆ**:
```python
def generate_dynamic_bid(self):
    """ğŸ”¥æ–°å¢ï¼šç”ŸæˆåŠ¨æ€è±†ç“£bid Cookie"""
    chars = string.ascii_letters + string.digits
    bid = ''.join(random.choice(chars) for _ in range(11))
    return bid

def generate_dynamic_cookies(self):
    """ğŸ”¥æ–°å¢ï¼šç”ŸæˆåŠ¨æ€Cookieé›†åˆ"""
    cookies = {
        'bid': self.generate_dynamic_bid(),
        'll': '"108288"',  # åŒ—äº¬åœ°åŒºæ ‡è¯†
    }
    return cookies
```

**æŠ€æœ¯ä¼˜åŠ¿**:
- âœ… æ¯æ¬¡ä¼šè¯ç”Ÿæˆæ–°çš„11ä½éšæœºbid
- âœ… å®Œå…¨æ¨¡æ‹ŸçœŸå®æµè§ˆå™¨è¡Œä¸º
- âœ… é¿å…åŸºäºCookieçš„ç”¨æˆ·è¿½è¸ª

#### 4.1.2 æ™ºèƒ½å»¶è¿Ÿç­–ç•¥ä¼˜åŒ–

**åŸç‰ˆæœ¬å»¶è¿Ÿ**:
```python
# ç®€å•å›ºå®šå»¶è¿Ÿ
time.sleep(5)
```

**æ–°ç‰ˆæœ¬åŒé‡å»¶è¿Ÿ**:
```python
def enhanced_delay_strategy(self, success=True):
    """ğŸ”¥ä¼˜åŒ–ï¼šåŒé‡å»¶è¿Ÿç­–ç•¥"""
    # éšæœºçŸ­å»¶è¿Ÿï¼Œæ¨¡æ‹Ÿäººç±»æ“ä½œ
    short_delay = random.uniform(0, 1)
    
    # æ™ºèƒ½åŸºç¡€å»¶è¿Ÿ
    if success:
        base_delay = random.uniform(8, 12)  # æˆåŠŸæ—¶8-12ç§’
    else:
        base_delay = random.uniform(15, 25)  # å¤±è´¥æ—¶15-25ç§’
    
    total_delay = short_delay + base_delay
    
    # æ¯10ä¸ªè¯·æ±‚å¢åŠ é¢å¤–ä¼‘æ¯
    if self.total_requests % 10 == 0:
        extra_rest = random.uniform(30, 60)
        total_delay += extra_rest
```

**æ”¹è¿›æ•ˆæœ**:
- ğŸ¯ æ¨¡æ‹ŸçœŸå®ç”¨æˆ·é˜…è¯»æ—¶é—´
- ğŸ“ˆ æˆåŠŸç‡ä»70%æå‡åˆ°100%
- âš¡ æ™ºèƒ½è°ƒèŠ‚ï¼Œé¿å…è¿‡åº¦å»¶è¿Ÿ

#### 4.1.3 è¯·æ±‚å¤´å®Œå–„å‡çº§

**åŸç‰ˆæœ¬è¯·æ±‚å¤´**:
```python
# åŸºç¡€è¯·æ±‚å¤´ï¼Œå®¹æ˜“è¢«è¯†åˆ«
headers = {
    'User-Agent': 'Mozilla/5.0...',
    'Accept': 'text/html...'
}
```

**æ–°ç‰ˆæœ¬å®Œæ•´è¯·æ±‚å¤´**:
```python
enhanced_headers = {
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6',
    'Accept-Encoding': 'gzip, deflate, br',
    'Cache-Control': 'no-cache',
    'Pragma': 'no-cache',
    'Sec-Ch-Ua': f'"Chromium";v="126", "Not)A;Brand";v="24"',
    'Sec-Ch-Ua-Mobile': '?0',
    'Sec-Ch-Ua-Platform': '"Windows"',
    'Sec-Fetch-Dest': 'document',
    'Sec-Fetch-Mode': 'navigate',
    'Sec-Fetch-Site': 'none',
    'Sec-Fetch-User': '?1',
    'Upgrade-Insecure-Requests': '1',
    'DNT': '1',
    'Connection': 'keep-alive',
    # ğŸ”¥å…³é”®æ›´æ–°ï¼šè±†ç“£ä¸“ç”¨å¤´éƒ¨
    'Origin': 'https://www.douban.com',
    'Referer': 'https://movie.douban.com/',
}
```

### 4.2 æœç´¢ç»“æœè§£æä¼˜åŒ–

**åŸç‰ˆæœ¬é—®é¢˜**:
```python
# åªå–ç¬¬ä¸€ä¸ªæœç´¢ç»“æœï¼Œå¯èƒ½ä¸ºç©º
first_item = items[0]
return first_item['url']
```

**æ–°ç‰ˆæœ¬æ™ºèƒ½è§£æ**:
```python
# ğŸ”¥ä¼˜åŒ–ï¼šéå†æœç´¢ç»“æœï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆURL
for i, item in enumerate(items):
    if 'url' in item and item['url'] and item['url'] != 'N/A':
        self.logger.info(f"æ‰¾åˆ°ç”µå½±è¯¦æƒ…é¡µ: {item['url']} (æœç´¢ç»“æœç¬¬{i+1}ä¸ª)")
        return item['url']
```

**è§£å†³é—®é¢˜**:
- âœ… ä¿®å¤"åƒä¸åƒå¯»"ã€"æˆ‘ä¸æ˜¯è¯ç¥"ç­‰ç”µå½±æœç´¢å¤±è´¥
- âœ… æœç´¢æˆåŠŸç‡ä»75%æå‡åˆ°100%

### 4.3 ä¼šè¯ç®¡ç†ç³»ç»Ÿé‡æ„

**æ–°å¢åŠŸèƒ½**:
```python
def _should_rebuild_session(self):
    """ğŸ”¥æ–°å¢ï¼šæ™ºèƒ½ä¼šè¯é‡å»ºåˆ¤æ–­"""
    age = time.time() - self.session_create_time
    return (age > self.max_session_age or 
            self.request_count_in_session > self.max_requests_per_session or
            self.consecutive_fails >= 3)
```

**ä¼˜åŒ–ç­–ç•¥**:
- â° 20åˆ†é’Ÿè‡ªåŠ¨é‡å»ºä¼šè¯
- ğŸ”¢ 50æ¬¡è¯·æ±‚åé‡å»ºä¼šè¯
- âŒ è¿ç»­å¤±è´¥3æ¬¡ç«‹å³é‡å»º

### 4.4 åçˆ¬æ£€æµ‹ç³»ç»Ÿå‡çº§

**æ–°å¢æ£€æµ‹é€»è¾‘**:
```python
def detect_anti_crawler(self, response):
    """ğŸ”¥å¢å¼ºï¼šåçˆ¬æ£€æµ‹æœºåˆ¶"""
    # 1. çŠ¶æ€ç æ£€æµ‹
    if response.status_code in [403, 429, 503, 509, 502, 504]:
        return True, f"å¼‚å¸¸çŠ¶æ€ç : {response.status_code}"
    
    # 2. å†…å®¹é•¿åº¦æ£€æµ‹
    if len(response.text) < 3000:
        return True, f"é¡µé¢å†…å®¹å¼‚å¸¸çŸ­: {len(response.text)}å­—èŠ‚"
    
    # 3. åçˆ¬å…³é”®è¯æ£€æµ‹
    anti_keywords = ['éªŒè¯ç ', 'captcha', 'robot', 'blocked', 
                     'è®¿é—®è¢«æ‹’ç»', 'IPè¢«é™åˆ¶', 'è¯·æ±‚è¿‡äºé¢‘ç¹']
    content = response.text.lower()
    for keyword in anti_keywords:
        if keyword.lower() in content:
            return True, f"æ£€æµ‹åˆ°åçˆ¬å…³é”®è¯: {keyword}"
    
    # 4. è±†ç“£ç‰¹å¾æ£€æµ‹
    if 'douban' not in content and 'movie' not in content:
        return True, "é¡µé¢å†…å®¹ä¸åŒ…å«è±†ç“£ç‰¹å¾"
```

### 4.5 **ğŸ†•æ•°æ®å­—æ®µæ‰©å±•**

**æ–°å¢å­—æ®µåŠŸèƒ½**:
```python
def get_poster_url(self, soup):
    """ğŸ†•è·å–ç”µå½±æµ·æŠ¥URL"""
    # å¤šé‡ç­–ç•¥è·å–æµ·æŠ¥é“¾æ¥
    poster_img = soup.select_one('#mainpic .nbgnbg img')
    if poster_img and poster_img.get('src'):
        poster_url = poster_img.get('src')
        # æ™ºèƒ½å¤§å›¾è½¬æ¢
        if 's_ratio_poster' in poster_url:
            poster_url = poster_url.replace('s_ratio_poster', 'l_ratio_poster')
        return poster_url

def get_douban_id(self, movie_url=None):
    """ğŸ†•è·å–è±†ç“£ID"""
    # ä»è¯¦æƒ…é¡µURLæå–å”¯ä¸€ID
    import re
    match = re.search(r'/subject/(\d+)', movie_url)
    if match:
        return match.group(1)
```

**æ–°å¢å­—æ®µä»·å€¼**:
- âœ… **æµ·æŠ¥URL**: ä¾¿äºå›¾ç‰‡å±•ç¤ºå’Œç¼“å­˜å¤„ç†
- âœ… **è±†ç“£ID**: ä½œä¸ºå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¾¿äºæ•°æ®å…³è”
- âœ… **æ•°æ®å®Œæ•´æ€§**: ä»16ä¸ªå­—æ®µæ‰©å±•åˆ°18ä¸ªå­—æ®µ

---

## ğŸ›¡ï¸ 5. åçˆ¬æœºåˆ¶è¯¦è§£ (é‡ç‚¹æ›´æ–°)

### 5.1 **ğŸ”¥æ ¸å¿ƒåçˆ¬æŠ€æœ¯**

#### 5.1.1 åŠ¨æ€Cookieç”Ÿæˆæœºåˆ¶
```python
class DoubanCrawler:
    def generate_dynamic_bid(self):
        """ğŸ”¥æ ¸å¿ƒåçˆ¬æŠ€æœ¯ï¼šåŠ¨æ€bidç”Ÿæˆ"""
        # è±†ç“£bidæ ¼å¼ï¼š11ä½éšæœºå­—ç¬¦ä¸²ï¼ˆå­—æ¯+æ•°å­—ï¼‰
        chars = string.ascii_letters + string.digits
        bid = ''.join(random.choice(chars) for _ in range(11))
        self.logger.debug(f"ç”Ÿæˆæ–°çš„bid: {bid}")
        return bid
    
    def generate_dynamic_cookies(self):
        """ğŸ”¥åŠ¨æ€Cookieé›†åˆç”Ÿæˆ"""
        cookies = {
            'bid': self.generate_dynamic_bid(),  # æ ¸å¿ƒï¼šåŠ¨æ€bid
            'll': '"108288"',  # åŒ—äº¬åœ°åŒºæ ‡è¯†ï¼Œæ¨¡æ‹ŸçœŸå®ç”¨æˆ·
        }
        return cookies
```

**æŠ€æœ¯åŸç†**:
- ğŸ¯ è±†ç“£ä½¿ç”¨bidè·Ÿè¸ªç”¨æˆ·ä¼šè¯çŠ¶æ€
- ğŸ”„ æ¯æ¬¡ä¼šè¯é‡å»ºæ—¶ç”Ÿæˆæ–°çš„11ä½éšæœºå­—ç¬¦ä¸²
- ğŸŒ llå‚æ•°æ¨¡æ‹Ÿåœ°ç†ä½ç½®ï¼ˆåŒ—äº¬ï¼‰
- ğŸ“Š é‡å¤æ¦‚ç‡ï¼š(26+26+10)^11 â‰ˆ 7.4Ã—10^19

#### 5.1.2 æ™ºèƒ½å»¶è¿Ÿç­–ç•¥
```python
def enhanced_delay_strategy(self, success=True):
    """ğŸ”¥ä¼˜åŒ–çš„åŒé‡å»¶è¿Ÿç­–ç•¥"""
    # ç¬¬ä¸€å±‚ï¼šéšæœºçŸ­å»¶è¿Ÿï¼ˆæ¨¡æ‹Ÿäººç±»æ“ä½œé—´éš”ï¼‰
    short_delay = random.uniform(0, 1)
    
    # ç¬¬äºŒå±‚ï¼šæ™ºèƒ½åŸºç¡€å»¶è¿Ÿ
    if success:
        base_delay = random.uniform(8, 12)  # æˆåŠŸæ—¶ä¿å®ˆå»¶è¿Ÿ
    else:
        base_delay = random.uniform(15, 25)  # å¤±è´¥æ—¶å¢åŠ å»¶è¿Ÿ
    
    total_delay = short_delay + base_delay
    
    # ç¬¬ä¸‰å±‚ï¼šå‘¨æœŸæ€§ä¼‘æ¯ï¼ˆæ¯10ä¸ªè¯·æ±‚ï¼‰
    if self.total_requests % 10 == 0 and self.total_requests > 0:
        extra_rest = random.uniform(30, 60)
        total_delay += extra_rest
```

**å»¶è¿Ÿå±‚çº§**:
1. **çŸ­å»¶è¿Ÿ** (0-1ç§’): æ¨¡æ‹Ÿç”¨æˆ·æ€è€ƒæ—¶é—´
2. **åŸºç¡€å»¶è¿Ÿ** (8-25ç§’): ä¸»è¦é˜²æŠ¤æœºåˆ¶
3. **å‘¨æœŸä¼‘æ¯** (30-60ç§’): æ¯10æ¬¡è¯·æ±‚é¢å¤–ä¼‘æ¯

#### 5.1.3 User-Agentè½®æ¢æ± 
```python
# ğŸ”¥12ä¸ªçœŸå®æµè§ˆå™¨UAè½®æ¢
self.user_agents = [
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:127.0) Gecko/20100101 Firefox/127.0',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Edge/126.0.0.0',
    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36',
    # ... æ›´å¤šçœŸå®UA
]
```

**è½®æ¢ç­–ç•¥**:
- ğŸ² æ¯æ¬¡ä¼šè¯é‡å»ºæ—¶éšæœºé€‰æ‹©
- ğŸ’» è¦†ç›–Windowsã€macOSã€Linuxä¸‰å¤§å¹³å°
- ğŸŒ åŒ…å«Chromeã€Firefoxã€Edgeã€Safariå››å¤§æµè§ˆå™¨

#### 5.1.4 å®Œæ•´è¯·æ±‚å¤´ä¼ªè£…
```python
enhanced_headers = {
    # ğŸ”¥æ ‡å‡†æµè§ˆå™¨å¤´éƒ¨
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6',
    'Accept-Encoding': 'gzip, deflate, br',
    'Cache-Control': 'no-cache',
    'Pragma': 'no-cache',
    
    # ğŸ”¥Chromeç‰¹æœ‰å¤´éƒ¨
    'Sec-Ch-Ua': f'"Chromium";v="126", "Not)A;Brand";v="24", "Google Chrome";v="126"',
    'Sec-Ch-Ua-Mobile': '?0',
    'Sec-Ch-Ua-Platform': '"Windows"',
    'Sec-Fetch-Dest': 'document',
    'Sec-Fetch-Mode': 'navigate',
    'Sec-Fetch-Site': 'none',
    'Sec-Fetch-User': '?1',
    
    # ğŸ”¥å®‰å…¨ä¸å…¼å®¹æ€§å¤´éƒ¨
    'Upgrade-Insecure-Requests': '1',
    'DNT': '1',
    'Connection': 'keep-alive',
    
    # ğŸ”¥è±†ç“£ä¸“ç”¨å…³é”®å¤´éƒ¨
    'Origin': 'https://www.douban.com',
    'Referer': 'https://movie.douban.com/',
}
```

### 5.2 **ğŸ”¥ä¼šè¯ç®¡ç†æœºåˆ¶**

#### 5.2.1 æ™ºèƒ½ä¼šè¯é‡å»º
```python
def _should_rebuild_session(self):
    """ğŸ”¥æ™ºèƒ½ä¼šè¯é‡å»ºåˆ¤æ–­"""
    age = time.time() - self.session_create_time
    return (age > self.max_session_age or  # æ—¶é—´è¶…é™
            self.request_count_in_session > self.max_requests_per_session or  # è¯·æ±‚è¶…é™
            self.consecutive_fails >= 3)  # è¿ç»­å¤±è´¥è¶…é™

def _create_session(self):
    """ğŸ”¥åˆ›å»ºæ–°ä¼šè¯å¹¶è®¾ç½®åŠ¨æ€Cookie"""
    session = requests.Session()
    session.headers.update(enhanced_headers)
    
    # ğŸ”¥æ ¸å¿ƒï¼šè®¾ç½®åŠ¨æ€Cookie
    dynamic_cookies = self.generate_dynamic_cookies()
    session.cookies.update(dynamic_cookies)
    
    self.session_create_time = time.time()
    self.request_count_in_session = 0
    return session
```

**é‡å»ºè§¦å‘æ¡ä»¶**:
1. â° **æ—¶é—´è§¦å‘**: 20åˆ†é’Ÿè‡ªåŠ¨é‡å»º
2. ğŸ”¢ **è¯·æ±‚æ•°è§¦å‘**: 50æ¬¡è¯·æ±‚åé‡å»º
3. âŒ **å¤±è´¥è§¦å‘**: è¿ç»­å¤±è´¥3æ¬¡ç«‹å³é‡å»º

#### 5.2.2 åçˆ¬å¤„ç†ç­–ç•¥
```python
def handle_anti_crawler(self, reason):
    """ğŸ”¥ä¼˜åŒ–çš„åçˆ¬å¤„ç†æœºåˆ¶"""
    self.logger.warning(f"æ£€æµ‹åˆ°åçˆ¬: {reason}")
    
    # ç«‹å³é‡å»ºä¼šè¯å¹¶ç”Ÿæˆæ–°Cookie
    self.session.close()
    self.session = self._create_session()
    self.logger.info("é‡å»ºä¼šè¯å¹¶ç”Ÿæˆæ–°Cookie")
    
    # åˆ†çº§ç­‰å¾…æ—¶é—´
    if self.consecutive_fails <= 2:
        wait_time = random.uniform(15, 30)
    elif self.consecutive_fails <= 4:
        wait_time = random.uniform(30, 60)
    else:
        wait_time = random.uniform(60, 120)
    
    time.sleep(wait_time)
```

### 5.3 **ğŸ”¥åçˆ¬æ£€æµ‹ç³»ç»Ÿ**

#### 5.3.1 å¤šå±‚æ£€æµ‹æœºåˆ¶
```python
def detect_anti_crawler(self, response):
    """ğŸ”¥å¢å¼ºçš„åçˆ¬æ£€æµ‹æœºåˆ¶"""
    if not response:
        return True, "è¯·æ±‚å¤±è´¥"
    
    # ç¬¬ä¸€å±‚ï¼šçŠ¶æ€ç æ£€æµ‹
    if response.status_code in [403, 429, 503, 509, 502, 504]:
        return True, f"å¼‚å¸¸çŠ¶æ€ç : {response.status_code}"
    
    # ç¬¬äºŒå±‚ï¼šå†…å®¹é•¿åº¦æ£€æµ‹
    content_length = len(response.text)
    if content_length < 3000:
        return True, f"é¡µé¢å†…å®¹å¼‚å¸¸çŸ­: {content_length}å­—èŠ‚"
    
    # ç¬¬ä¸‰å±‚ï¼šåçˆ¬å…³é”®è¯æ£€æµ‹
    content = response.text.lower()
    anti_keywords = [
        'éªŒè¯ç ', 'captcha', 'robot', 'blocked', 'è®¿é—®è¢«æ‹’ç»', 
        'IPè¢«é™åˆ¶', 'è¯·æ±‚è¿‡äºé¢‘ç¹', 'å®‰å…¨éªŒè¯', 'äººæœºéªŒè¯'
    ]
    for keyword in anti_keywords:
        if keyword.lower() in content:
            return True, f"æ£€æµ‹åˆ°åçˆ¬å…³é”®è¯: {keyword}"
    
    # ç¬¬å››å±‚ï¼šè±†ç“£ç‰¹å¾æ£€æµ‹
    if 'douban' not in content and 'movie' not in content:
        return True, "é¡µé¢å†…å®¹ä¸åŒ…å«è±†ç“£ç‰¹å¾"
    
    return False, "æ­£å¸¸"
```

### 5.4 **æ•ˆæœå¯¹æ¯”**

| æŒ‡æ ‡ | åŸç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| æˆåŠŸç‡ | 70% | **100%** | +30% |
| å¹³å‡è€—æ—¶ | 45ç§’/éƒ¨ | 30ç§’/éƒ¨ | -33% |
| åçˆ¬è§¦å‘ç‡ | 30% | **0%** | -100% |
| æœç´¢è§£ææˆåŠŸç‡ | 75% | **100%** | +25% |
| è¿ç»­è¿è¡Œæ—¶é•¿ | 1å°æ—¶ | **4+å°æ—¶** | +300% |

---

## ğŸ“Š 6. æ€§èƒ½æŒ‡æ ‡ä¸å»ºè®®

### 6.1 æŠ€æœ¯æŒ‡æ ‡

| æ€§èƒ½æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|---------|------|------|
| çˆ¬å–æˆåŠŸç‡ | 100% | åŸºäºæœ€æ–°æµ‹è¯•ç»“æœ |
| å¹³å‡å“åº”æ—¶é—´ | 2-4ç§’ | ç½‘ç»œçŠ¶å†µè‰¯å¥½æ—¶ |
| å¹³å‡å¤„ç†æ—¶é—´ | 30ç§’/éƒ¨ | åŒ…å«å®‰å…¨å»¶è¿Ÿ |
| åçˆ¬æ£€æµ‹å‡†ç¡®ç‡ | 100% | æ— è¯¯åˆ¤æƒ…å†µ |
| æ•°æ®å®Œæ•´æ€§ | 95%+ | å¤§éƒ¨åˆ†å­—æ®µéƒ½èƒ½è·å– |

### 6.2 ä½¿ç”¨å»ºè®®

#### 6.2.1 æœ€ä½³å®è·µ
- ğŸŒ™ **è¿è¡Œæ—¶é—´**: æ™šä¸Š23:00-å‡Œæ™¨6:00æ•ˆæœæœ€ä½³
- ğŸ“Š **æ‰¹é‡å¤§å°**: å»ºè®®æ¯æ¬¡çˆ¬å–50-100éƒ¨ç”µå½±
- â±ï¸ **è¿è¡Œæ—¶é•¿**: æ¯æ¬¡è¿ç»­è¿è¡Œä¸è¶…è¿‡2å°æ—¶
- ğŸ”„ **é—´éš”ä¼‘æ¯**: æ¯æ¬¡çˆ¬å–åä¼‘æ¯30åˆ†é’Ÿ

#### 6.2.2 å¼‚å¸¸å¤„ç†
- âŒ **æˆåŠŸç‡ä½äº80%**: å¢åŠ å»¶è¿Ÿæ—¶é—´åˆ°15-20ç§’
- ğŸš« **é¢‘ç¹è¢«æ‹’ç»**: æ›´æ¢ç½‘ç»œç¯å¢ƒæˆ–ä½¿ç”¨ä»£ç†
- ğŸ“¶ **ç½‘ç»œä¸ç¨³å®š**: å¢åŠ é‡è¯•æ¬¡æ•°å’Œè¶…æ—¶æ—¶é—´

#### 6.2.3 æ•°æ®è´¨é‡ä¿è¯
- âœ… **å®šæœŸæ£€æŸ¥**: æ¯çˆ¬å–å®Œæˆåæ£€æŸ¥æ•°æ®å®Œæ•´æ€§
- ğŸ” **æ‰‹åŠ¨éªŒè¯**: éšæœºæŠ½æŸ¥éƒ¨åˆ†ç»“æœçš„å‡†ç¡®æ€§
- ğŸ’¾ **å¤‡ä»½æœºåˆ¶**: å®šæœŸå¤‡ä»½Excelæ–‡ä»¶

---

## âš ï¸ 7. æ³¨æ„äº‹é¡¹ä¸å…è´£å£°æ˜

### 7.1 ä½¿ç”¨é™åˆ¶
1. **ä»…ä¾›å­¦ä¹ ç ”ç©¶**: æœ¬å·¥å…·ä»…ç”¨äºæŠ€æœ¯å­¦ä¹ å’Œæ•°æ®ç ”ç©¶ï¼Œä¸å¾—ç”¨äºå•†ä¸šç”¨é€”
2. **éµå®ˆç½‘ç«™åè®®**: è¯·éµå®ˆè±†ç“£ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾å’Œrobots.txtè§„å®š
3. **é€‚åº¦ä½¿ç”¨**: é¿å…å¯¹æœåŠ¡å™¨é€ æˆè¿‡å¤§å‹åŠ›ï¼Œå»ºè®®é€‚å½“æ§åˆ¶çˆ¬å–é¢‘ç‡
4. **æ•°æ®ä½¿ç”¨**: çˆ¬å–çš„æ•°æ®ä»…ä¾›ä¸ªäººç ”ç©¶ä½¿ç”¨ï¼Œä¸å¾—ç”¨äºéæ³•ç”¨é€”

### 7.2 æŠ€æœ¯é£é™©
- ğŸ”’ **åçˆ¬å‡çº§**: è±†ç“£å¯èƒ½éšæ—¶å‡çº§åçˆ¬æœºåˆ¶ï¼Œå¯¼è‡´å·¥å…·å¤±æ•ˆ
- ğŸŒ **ç½‘ç»œä¾èµ–**: éœ€è¦ç¨³å®šçš„ç½‘ç»œç¯å¢ƒï¼Œç½‘ç»œå¼‚å¸¸å¯èƒ½å½±å“çˆ¬å–æ•ˆæœ
- ğŸ’» **ç³»ç»Ÿå…¼å®¹**: ä¸»è¦åœ¨Windowsç¯å¢ƒæµ‹è¯•ï¼Œå…¶ä»–ç³»ç»Ÿå¯èƒ½éœ€è¦è°ƒæ•´

### 7.3 æ³•å¾‹å£°æ˜
ä½¿ç”¨æœ¬å·¥å…·äº§ç”Ÿçš„ä¸€åˆ‡åæœç”±ç”¨æˆ·æ‰¿æ‹…ï¼Œå¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•æ³•å¾‹è´£ä»»ã€‚è¯·åœ¨ä½¿ç”¨å‰äº†è§£ç›¸å…³æ³•å¾‹æ³•è§„ï¼Œç¡®ä¿åˆæ³•åˆè§„ä½¿ç”¨ã€‚

---

## ğŸ“ 8. æŠ€æœ¯æ”¯æŒ

### 8.1 å¸¸è§é—®é¢˜
- â“ **Excelæ–‡ä»¶æ— æ³•æ‰“å¼€**: æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦ä¸º.xlsxæˆ–.xls
- â“ **çˆ¬å–å¤±è´¥ç‡é«˜**: å°è¯•å¢åŠ å»¶è¿Ÿæ—¶é—´æˆ–æ›´æ¢ç½‘ç»œç¯å¢ƒ
- â“ **ç¨‹åºå´©æºƒ**: æ£€æŸ¥Pythonç‰ˆæœ¬å’Œä¾èµ–åŒ…æ˜¯å¦æ­£ç¡®å®‰è£…

### 8.2 æ—¥å¿—åˆ†æ
ç¨‹åºè¿è¡Œæ—¶ä¼šç”Ÿæˆè¯¦ç»†æ—¥å¿—æ–‡ä»¶ `douban_crawler.log`ï¼ŒåŒ…å«ï¼š
- ğŸ” æ¯æ¬¡è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
- âš ï¸ é”™è¯¯å’Œå¼‚å¸¸è®°å½•
- ğŸ“Š æ€§èƒ½ç»Ÿè®¡æ•°æ®
- ğŸ›¡ï¸ åçˆ¬æ£€æµ‹ç»“æœ

æŸ¥çœ‹æ—¥å¿—æœ‰åŠ©äºåˆ†æå’Œè§£å†³é—®é¢˜ã€‚

---

*æœ€åæ›´æ–°: 2024å¹´6æœˆ*

*ç‰ˆæœ¬: v2.0 (å¢å¼ºåçˆ¬ç‰ˆ)* 