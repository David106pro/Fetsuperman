# 建筑DWG柱子区域统计分析脚本

## 项目概述

这是一个高级的Python脚本，专门用于分析建筑DWG文件（转换为DXF格式）并按预定义区域统计柱子数量。脚本能够自动识别轴网坐标，定位柱子位置，并按照11个预设区域进行分类统计。

## 核心功能

### 1. 轴网坐标识别
- **数字轴网**：自动识别纯数字标记（如'17', '25'），记录X坐标
- **字母轴网**：自动识别纯字母标记（如'AA', 'N'），记录Y坐标
- **容错处理**：处理重复轴网标记，取第一个找到的坐标

### 2. 区域边界计算
- 根据轴网坐标将文本范围（如'17-25'/'AA-N'）转换为实际坐标边界
- 自动处理坐标范围的正确性（确保min < max）
- 提供详细的缺失轴网警告信息

### 3. 柱子识别与定位
- **文本实体**：识别包含'Z'字符的TEXT和MTEXT实体
- **块引用**：检查INSERT块的名称和属性文字
- **坐标记录**：精确记录每个柱子的(x, y)坐标

### 4. 智能匹配与统计
- 将每个柱子坐标与11个区域边界进行匹配
- 按负责人分组统计结果
- 提供未匹配柱子的详细信息

## 文件结构

```
找柱子/
├── main.py                    # 主脚本文件
├── config.py                  # 配置文件
├── create_test_dxf.py         # 测试DXF文件生成器
├── test_structure.dxf         # 测试用DXF文件
├── 柱子统计分析.log           # 运行日志
└── 柱子统计分析脚本记录.md    # 使用文档（本文件）
```

## 安装与环境要求

### 系统要求
- Python 3.7+
- Windows/Linux/macOS

### 依赖库安装
```bash
pip install ezdxf
```

### 环境验证
```bash
python -c "import ezdxf; print('ezdxf版本:', ezdxf.version)"
```

## 配置说明

### config.py 配置文件

```python
# DXF文件路径配置
DXF_FILE_PATH = r"你的DXF文件路径.dxf"

# 区域定义配置
REGIONS_CONFIG = [
    {
        'name': '负责人姓名',
        'x_range': 'X轴范围',
        'y_range': 'Y轴范围', 
        'description': '显示描述'
    },
    # ... 更多区域
]

# 柱子识别标识符
COLUMN_IDENTIFIER = 'Z'

# 日志配置
LOG_FILE = '柱子统计分析.log'
LOG_LEVEL = 'INFO'  # DEBUG, INFO, WARNING, ERROR
```

### 区域配置详解

当前预设的11个区域：

| 负责人 | X轴范围 | Y轴范围 | 描述 |
|--------|---------|---------|------|
| 吴晨料 | 17-25   | AA-N    | 吴晨料: (17-25/AA-N) |
| 吴晨料 | 27-35   | AA-N    | 吴晨料: (27-35/AA-N) |
| 吴晨料 | 21-27   | CA-N    | 吴晨料: (21-27/CA-N) |
| 王姣   | 9-15    | E-M     | 王姣: (9-15/E-M) |
| 王姣   | 15-21   | E-N     | 王姣: (15-21/E-N) |
| 王姣   | 1-55    | F-H     | 王姣: (1-55/F-H) |
| 王姣   | 5-9     | E-M     | 王姣: (5-9/E-M) |
| 度小彤 | 15-21   | X-CA    | 度小彤: (15-21/X-CA) |
| 度小彤 | 9-15    | X-CA    | 度小彤: (9-15/X-CA) |
| 度小彤 | 5-10    | AA-M    | 度小彤: (5-10/AA-M) |
| 度小彤 | 1-5     | X-CA    | 度小彤: (1-5/X-CA) |

## 使用方法

### 第一步：文件格式转换

由于ezdxf库只支持DXF格式，需要先将DWG文件转换：

1. 在AutoCAD中打开DWG文件
2. 选择 **文件** → **另存为**
3. 在格式下拉菜单中选择 **"AutoCAD DXF (*.dxf)"**
4. 保存文件

### 第二步：配置文件路径

编辑 `config.py` 文件：
```python
DXF_FILE_PATH = r"你的实际DXF文件完整路径"
```

### 第三步：运行分析

```bash
python main.py
```

### 第四步：查看结果

脚本会输出：
- 控制台实时显示分析进度
- 按负责人分组的统计结果
- 详细日志保存到 `柱子统计分析.log`

## 输出结果示例

```
建筑DWG/DXF文件柱子区域统计分析脚本
==================================================

【吴晨料】负责区域：
  吴晨料: (17-25/AA-N) - 柱子数量: 10个
  吴晨料: (27-35/AA-N) - 柱子数量: 3个
  吴晨料: (21-27/CA-N) - 柱子数量: 0个
  吴晨料 负责区域总计: 13个柱子

【王姣】负责区域：
  王姣: (9-15/E-M) - 柱子数量: 4个
  王姣: (15-21/E-N) - 柱子数量: 1个
  王姣: (1-55/F-H) - 柱子数量: 2个
  王姣: (5-9/E-M) - 柱子数量: 2个
  王姣 负责区域总计: 9个柱子

【度小彤】负责区域：
  度小彤: (15-21/X-CA) - 柱子数量: 1个
  度小彤: (9-15/X-CA) - 柱子数量: 3个
  度小彤: (5-10/AA-M) - 柱子数量: 1个
  度小彤: (1-5/X-CA) - 柱子数量: 3个
  度小彤 负责区域总计: 8个柱子

------------------------------------------------------------
所有区域柱子总数: 30个
图纸中发现的柱子总数: 30个
```

## 错误处理与故障排除

### 常见问题

#### 1. "File is not a DXF file" 错误
**原因**：文件是DWG格式或文件损坏
**解决**：
- 确保文件是DXF格式
- 重新转换DWG文件为DXF
- 检查文件是否完整

#### 2. "未找到任何轴网坐标" 警告
**原因**：
- 轴网标记不是纯数字或纯字母
- 轴网标记在非标准图层
- 文字高度过小被忽略

**解决**：
- 检查轴网标记格式
- 调整日志级别为DEBUG查看详细信息
- 修改柱子识别逻辑（如需要）

#### 3. "柱子未匹配到任何区域" 警告
**原因**：
- 柱子位置超出所有定义区域
- 轴网坐标识别错误
- 区域定义有误

**解决**：
- 检查区域定义是否完整
- 验证轴网坐标是否正确
- 查看日志中的详细坐标信息

### 调试模式

启用详细日志：
```python
# 在config.py中设置
LOG_LEVEL = 'DEBUG'
```

这会输出：
- 每个找到的轴网坐标
- 每个找到的柱子位置
- 详细的匹配过程信息

## 高级功能

### 自定义柱子识别规则

如果需要识别其他类型的柱子标记，可以修改 `config.py`：

```python
# 识别包含'柱'字的中文标记
COLUMN_IDENTIFIER = '柱'

# 或者修改main.py中的识别逻辑以支持正则表达式
```

### 批量处理多个文件

可以扩展脚本以处理多个DXF文件：

```python
# 在main.py中添加循环处理逻辑
file_list = ['file1.dxf', 'file2.dxf', 'file3.dxf']
for file_path in file_list:
    analyzer = ColumnAnalyzer()
    analyzer.analyze_dwg(file_path)
```

### 结果导出

可以扩展脚本将结果导出为Excel或CSV：

```python
import pandas as pd

# 将统计结果保存为Excel
results_df = pd.DataFrame(region_counts.items(), 
                         columns=['区域', '柱子数量'])
results_df.to_excel('柱子统计结果.xlsx', index=False)
```

## 技术架构

### 核心类：ColumnAnalyzer

**主要方法：**
- `load_dwg_file()`: 加载DXF文件
- `extract_axis_coordinates()`: 提取轴网坐标
- `calculate_region_boundaries()`: 计算区域边界
- `find_columns()`: 查找柱子
- `match_columns_to_regions()`: 匹配柱子到区域
- `print_results()`: 输出结果

**数据结构：**
- `axis_coords`: 轴网坐标字典
- `columns`: 柱子坐标列表
- `regions`: 区域定义列表
- `region_counts`: 区域计数字典

### 处理流程

1. **初始化** → 加载配置和区域定义
2. **文件加载** → 验证并读取DXF文件
3. **轴网识别** → 遍历文本实体识别轴网
4. **边界计算** → 将轴网范围转换为坐标边界
5. **柱子定位** → 查找所有包含标识符的实体
6. **区域匹配** → 判断柱子属于哪个区域
7. **结果统计** → 按负责人分组统计并输出

## 性能优化

### 大文件处理建议

1. **内存优化**：对于大型DXF文件，可以分批处理实体
2. **索引优化**：为轴网坐标建立空间索引
3. **并行处理**：使用多进程处理多个文件

### 精度设置

```python
# 在config.py中添加坐标容差
COORDINATE_TOLERANCE = 0.1  # 轴网坐标允许的误差范围
```

## 扩展开发

### 添加新的区域类型

1. 在 `config.py` 中的 `REGIONS_CONFIG` 添加新区域
2. 确保轴网标记存在于DXF文件中
3. 测试边界计算是否正确

### 支持其他CAD格式

可以扩展支持其他格式：
- DWG直接读取（需要额外库如ODA File Converter）
- AutoCAD Script批量转换
- 其他CAD软件的原生格式

## 版本历史

### v1.0 (2025-01-27)
- ✅ 初始版本发布
- ✅ 支持DXF文件读取和解析
- ✅ 实现轴网坐标自动识别
- ✅ 实现11个预设区域的柱子统计
- ✅ 提供详细的日志和错误处理
- ✅ 包含完整的配置文件和测试用例

### v1.0.1 (2025-01-27) - 兼容性修复
- 🔧 修复Python 3.13环境下ezdxf库兼容性问题
- 🔧 降级使用ezdxf 1.3.0稳定版本
- ✅ 添加启动脚本.bat便于Windows用户使用
- ✅ 创建快速使用指南
- ✅ 增强错误处理和用户提示

### v1.1.0 (2025-01-27) - DWG文件支持
- 🎉 **新增DWG文件支持**：现在可以直接使用DWG文件
- ✅ 智能文件格式检测和转换指导
- ✅ 新增专用DWG转换工具 (`DWG转换工具.py`)
- ✅ 多种转换方案：AutoCAD、免费软件、在线服务
- ✅ 自动检测已转换的DXF文件
- ✅ 更新启动脚本支持转换和分析双功能
- 🔧 优化用户交互体验和错误提示

### 未来计划
- [ ] 支持DWG文件直接读取
- [ ] 添加图形界面(GUI)
- [ ] 结果导出为Excel/PDF报告
- [ ] 支持自定义区域形状（非矩形）
- [ ] 添加柱子类型分类统计
- [ ] 支持多楼层批量处理

## 技术支持

如果在使用过程中遇到问题，请：

1. 检查日志文件 `柱子统计分析.log` 中的详细信息
2. 确认DXF文件格式和轴网标记正确性
3. 验证配置文件设置
4. 启用DEBUG模式获取更多信息

## 许可证

本脚本为内部使用工具，请根据公司政策合理使用。

---

**创建时间**：2025年1月27日  
**版本**：1.0  
**维护者**：AI助手  
**最后更新**：2025年1月27日
